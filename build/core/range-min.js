KISSY.Editor.add("range",function(t){function z(a){this.endOffset=this.endContainer=this.startOffset=this.startContainer=null;this.collapsed=true;this.document=a}function I(a){var b=a[0].nodeType!=g.NODE_TEXT&&a._4e_name()in A.$removeEmpty,d=!r.trim(a[0].nodeValue);a=!!a.parent().attr("_ke_bookmark");return b||d||a}function E(a){return!J(a)&&!K(a)}function F(a){var b=false,d=u.bookmark(true);return function(e){if(d(e))return true;if(e[0].nodeType==g.NODE_TEXT){if(r.trim(e[0].nodeValue).length)return false}else if(e[0].nodeType==
g.NODE_ELEMENT)if(!L[e._4e_name()])if(!a&&!C.ie&&e._4e_name()=="br"&&!b)b=true;else return false;return true}}function M(a,b){function d(e){return e&&e.nodeName=="span"&&e.getAttribute("_ke_bookmark")}return function(e){var c,f;c=e&&!e.nodeName&&(f=e.parentNode)&&d(f);c=a?c:c||d(e);return b^c}}function N(a){return function(b){b=(b=b[0]||b)&&b.nodeType==g.NODE_TEXT&&!r.trim(b.nodeValue);return a^b}}t.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,
ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,STARTEND:3,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var r=KISSY,g=t.NODE,i=t.RANGE,O=t.POSITION,u=t.Walker,s=r.DOM,G=t.Utils.getByAddress,C=r.UA,A=t.XHTML_DTD,w=t.ElementPath,n=r.Node,H={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};z.prototype.toString=function(){var a=[];a.push((this.startContainer[0].id||this.startContainer[0].nodeName)+":"+this.startOffset);a.push((this.endContainer[0].id||this.endContainer[0].nodeName)+
":"+this.endOffset);return a.join("<br/>")};r.augment(z,{updateCollapsed:function(){this.collapsed=this.startContainer&&this.endContainer&&s._4e_equals(this.startContainer,this.endContainer)&&this.startOffset==this.endOffset},optimize:function(){var a=this.startContainer,b=this.startOffset;if(a[0].nodeType!=g.NODE_ELEMENT)if(b)b>=a[0].nodeValue.length&&this.setStartAfter(a);else this.setStartBefore(a);a=this.endContainer;b=this.endOffset;if(a[0].nodeType!=g.NODE_ELEMENT)if(b)b>=a[0].nodeValue.length&&
this.setEndAfter(a);else this.setEndBefore(a)},setStartAfter:function(a){this.setStart(a.parent(),a._4e_index()+1)},setStartBefore:function(a){this.setStart(a.parent(),a._4e_index())},setEndAfter:function(a){this.setEnd(a.parent(),a._4e_index()+1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4e_index())},optimizeBookmark:function(){var a=this.startContainer,b=this.endContainer;a&&a._4e_name()=="span"&&a.attr("_ke_bookmark")&&this.setStartAt(a,i.POSITION_BEFORE_START);b&&b._4e_name()=="span"&&
b.attr("_ke_bookmark")&&this.setEndAt(b,i.POSITION_AFTER_END)},setStart:function(a,b){if(a[0].nodeType==g.NODE_ELEMENT&&H[a._4e_name()]){a=a.parent();b=a._4e_index()}this.startContainer=a;this.startOffset=b;if(!this.endContainer){this.endContainer=a;this.endOffset=b}this.updateCollapsed()},setEnd:function(a,b){if(a[0].nodeType==g.NODE_ELEMENT&&H[a._4e_name()]){a=a.parent();b=a._4e_index()+1}this.endContainer=a;this.endOffset=b;if(!this.startContainer){this.startContainer=a;this.startOffset=b}this.updateCollapsed()},
setStartAt:function(a,b){switch(b){case i.POSITION_AFTER_START:this.setStart(a,0);break;case i.POSITION_BEFORE_END:a[0].nodeType==g.NODE_TEXT?this.setStart(a,a[0].nodeValue.length):this.setStart(a,a[0].childNodes.length);break;case i.POSITION_BEFORE_START:this.setStartBefore(a);break;case i.POSITION_AFTER_END:this.setStartAfter(a)}this.updateCollapsed()},setEndAt:function(a,b){switch(b){case i.POSITION_AFTER_START:this.setEnd(a,0);break;case i.POSITION_BEFORE_END:a[0].nodeType==g.NODE_TEXT?this.setEnd(a,
a[0].nodeValue.length):this.setEnd(a,a[0].childNodes.length);break;case i.POSITION_BEFORE_START:this.setEndBefore(a);break;case i.POSITION_AFTER_END:this.setEndAfter(a)}this.updateCollapsed()},execContentsAction:function(a,b){var d=this.startContainer,e=this.endContainer,c=this.startOffset,f=this.endOffset,l,o;this.optimizeBookmark();if(e[0].nodeType==g.NODE_TEXT)e=e._4e_splitText(f);else if(e[0].childNodes.length>0)if(f>=e[0].childNodes.length){e=new n(e[0].appendChild(this.document.createTextNode("")));
o=true}else e=new n(e[0].childNodes[f]);if(d[0].nodeType==g.NODE_TEXT){d._4e_splitText(c);if(s._4e_equals(d,e))e=new n(d[0].nextSibling)}else if(c)if(c>=d[0].childNodes.length){l=new n(this.document.createTextNode(""));d[0].appendChild(l[0]);d=l;l=true}else d=new n(d[0].childNodes[c].previousSibling);else{l=new n(this.document.createTextNode(""));s.insertBefore(l[0],d[0].firstChild);d=l;l=true}c=d._4e_parents();f=e._4e_parents();var h,m,j;for(h=0;h<c.length;h++){m=c[h];j=f[h];if(m[0]!==j[0])break}for(var p=
b,k,q,v,x=h;x<c.length;x++){k=c[x];if(p&&k[0]!==d[0])q=p.appendChild(k._4e_clone()[0]);for(k=k[0].nextSibling;k;){if(f[x]&&k==f[x][0]||k==e[0])break;v=k.nextSibling;if(a==2)p.appendChild(k.cloneNode(true));else{k.parentNode.removeChild(k);a==1&&p.appendChild(k)}k=v}if(q)p=q}p=b;for(b=h;b<f.length;b++){k=f[b];if(a>0&&k[0]!==e[0])q=p.appendChild(k._4e_clone()[0]);if(!c[b]||k[0].parentNode!==c[b][0].parentNode)for(k=k[0].previousSibling;k;){if(c[b]&&k==c[b][0]||k===d[0])break;v=k.previousSibling;if(a==
2)p.insertBefore(k.cloneNode(true),p.firstChild);else{k.parentNode.removeChild(k);a==1&&p.insertBefore(k,p.firstChild)}k=v}if(q)p=q}if(a==2){j=this.startContainer[0];if(j.nodeType==g.NODE_TEXT&&j.nextSibling&&j.nextSibling.nodeType==g.NODE_TEXT){j.data+=j.nextSibling.data;j.parentNode.removeChild(j.nextSibling)}j=this.endContainer[0];if(j.nodeType==g.NODE_TEXT&&j.nextSibling&&j.nextSibling.nodeType==g.NODE_TEXT){j.data+=j.nextSibling.data;j.parentNode.removeChild(j.nextSibling)}}else{if(m&&j&&(d[0].parentNode!=
m[0].parentNode||e[0].parentNode!=j[0].parentNode)){a=j._4e_index();l&&j[0].parentNode==d[0].parentNode&&a--;this.setStart(j.parent(),a)}this.collapse(true)}l&&d._4e_remove();o&&e[0].parentNode&&e._4e_remove()},collapse:function(a){if(a){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=this.endOffset}this.collapsed=true},clone:function(){var a=new z(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;
a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=this.collapsed;return a},getEnclosedNode:function(){var a=this.clone();a.optimize();if(a.startContainer[0].nodeType!=g.NODE_ELEMENT||a.endContainer[0].nodeType!=g.NODE_ELEMENT)return null;a=a.startContainer[0].childNodes[a.startOffset];for(var b=M(true,undefined),d=N(true),e=function(c){return d(c)&&b(c)};a&&e(a);)a=(new n(a))._4e_nextSourceNode()[0];return new n(a)},shrink:function(a,b){if(!this.collapsed){a=a||i.SHRINK_TEXT;
var d=this.clone(),e=this.startContainer,c=this.endContainer,f=this.startOffset,l=this.endOffset,o=1,h=1;if(e&&e[0].nodeType==g.NODE_TEXT)if(f)if(f>=e[0].nodeValue.length)d.setStartAfter(e);else{d.setStartBefore(e);o=0}else d.setStartBefore(e);if(c&&c[0].nodeType==g.NODE_TEXT)if(l)if(l>=c[0].nodeValue.length)d.setEndAfter(c);else{d.setEndAfter(c);h=0}else d.setEndBefore(c);d=new u(d);d.evaluator=function(j){j=j[0]||j;return j.nodeType==(a==i.SHRINK_ELEMENT?g.NODE_ELEMENT:g.NODE_TEXT)};var m;d.guard=
function(j,p){j=j[0]||j;if(a==i.SHRINK_ELEMENT&&j.nodeType==g.NODE_TEXT)return false;if(p&&j==m)return false;if(!p&&j.nodeType==g.NODE_ELEMENT)m=j;return true};if(o)(e=d[a==i.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(e,b?i.POSITION_AFTER_START:i.POSITION_BEFORE_START);if(h){d.reset();(d=d[a==i.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(d,b?i.POSITION_BEFORE_END:i.POSITION_AFTER_END)}return!!(o||h)}},getTouchedStartNode:function(){var a=this.startContainer;if(this.collapsed||
a[0].nodeType!=g.NODE_ELEMENT)return a;return a.childNodes[this.startOffset]||a},createBookmark2:function(a){var b=this.startContainer,d=this.endContainer,e=this.startOffset,c=this.endOffset,f,l;if(!b||!d)return{start:0,end:0};if(a){if(b[0].nodeType==g.NODE_ELEMENT)if((f=new n(b[0].childNodes[e]))&&f[0]&&f[0].nodeType==g.NODE_TEXT&&e>0&&f[0].previousSibling.nodeType==g.NODE_TEXT){b=f;e=0}for(;b[0].nodeType==g.NODE_TEXT&&(l=b._4e_previous())&&l[0].nodeType==g.NODE_TEXT;){b=l;e+=l[0].nodeValue.length}if(!this.collapsed){if(d[0].nodeType==
g.NODE_ELEMENT)if((f=new n(d[0].childNodes[c]))&&f[0]&&f[0].nodeType==g.NODE_TEXT&&c>0&&f[0].previousSibling.nodeType==g.NODE_TEXT){d=f;c=0}for(;d[0].nodeType==g.NODE_TEXT&&(l=d._4e_previous())&&l[0].nodeType==g.NODE_TEXT;){d=l;c+=l[0].nodeValue.length}}}return{start:b._4e_address(a),end:this.collapsed?null:d._4e_address(a),startOffset:e,endOffset:c,normalized:a,is2:true}},createBookmark:function(a){var b,d,e,c;b=new n("<span></span>",null,this.document);b.attr("_ke_bookmark",1);b.css("display","none");
b.html("&nbsp;");if(a){e=r.guid("ke_bm_");b.attr("id",e+"S")}if(!this.collapsed){d=b._4e_clone();d.html("&nbsp;");a&&d.attr("id",e+"E");c=this.clone();c.collapse();c.insertNode(d)}c=this.clone();c.collapse(true);c.insertNode(b);if(d){this.setStartAfter(b);this.setEndBefore(d)}else this.moveToPosition(b,i.POSITION_AFTER_END);return{startNode:a?e+"S":b,endNode:a?e+"E":d,serializable:a}},moveToPosition:function(a,b){this.setStartAt(a,b);this.collapse(true)},trim:function(a,b){var d=this.startContainer,
e=this.startOffset,c=this.collapsed;if((!a||c)&&d[0]&&d[0].nodeType==g.NODE_TEXT){if(e)if(e>=d[0].nodeValue.length){e=d._4e_index()+1;d=d.parent()}else{a=d._4e_splitText(e);e=d._4e_index()+1;d=d.parent();if(s._4e_equals(this.startContainer,this.endContainer))this.setEnd(a,this.endOffset-this.startOffset);else if(s._4e_equals(d,this.endContainer))this.endOffset+=1}else{e=d._4e_index();d=d.parent()}this.setStart(d,e);if(c){this.collapse(true);return}}d=this.endContainer;e=this.endOffset;if(!(b||c)&&
d[0]&&d[0].nodeType==g.NODE_TEXT){if(e){e>=d.nodeValue.length||d._4e_splitText(e);e=d._4e_index()+1}else e=d._4e_index();d=d.parent();this.setEnd(d,e)}},insertNode:function(a){this.optimizeBookmark();this.trim(false,true);var b=this.startContainer,d=b[0].childNodes[this.startOffset];this.optimizeBookmark();this.trim(false,true);d?s.insertBefore(a[0]||a,d):b[0].appendChild(a[0]||a);s._4e_equals(a.parent(),this.endContainer)&&this.endOffset++;this.setStartBefore(a)},moveToBookmark:function(a){if(a.is2){var b=
G(this.document,a.start,a.normalized),d=a.startOffset,e=a.end&&G(this.document,a.end,a.normalized);a=a.endOffset;this.setStart(b,d);e?this.setEnd(e,a):this.collapse(true)}else{b=(d=a.serializable)?r.one("#"+a.startNode,this.document):a.startNode;a=d?r.one("#"+a.endNode,this.document):a.endNode;this.setStartBefore(b);b._4e_remove();if(a&&a[0]){this.setEndBefore(a);a._4e_remove()}else this.collapse(true)}},getCommonAncestor:function(a,b){var d=this.startContainer,e=this.endContainer;a=s._4e_equals(d,
e)?a&&d[0].nodeType==g.NODE_ELEMENT&&this.startOffset==this.endOffset-1?new n(d[0].childNodes[this.startOffset]):d:d._4e_commonAncestor(e);return b&&a[0].nodeType==g.NODE_TEXT?a.parent():a},enlarge:function(a){switch(a){case i.ENLARGE_ELEMENT:if(this.collapsed)return;a=this.getCommonAncestor();var b=new n(this.document.body),d,e,c,f,l,o=false,h,m;h=this.startContainer;m=this.startOffset;if(h[0].nodeType==g.NODE_TEXT){if(m){h=!r.trim(h[0].nodeValue.substring(0,m)).length&&h;o=!!h}if(h)if(!(f=h[0].previousSibling))c=
h.parent()}else{if(m)f=h[0].childNodes[m-1]||h[0].lastChild;f||(c=h)}for(;c||f;){if(c&&!f){if(!l&&s._4e_equals(c,a))l=true;if(!b._4e_contains(c))break;if(!o||c.css("display")!="inline"){o=false;if(l)d=c;else this.setStartBefore(c)}f=c[0].previousSibling}for(;f;){h=false;if(f.nodeType==g.NODE_TEXT){m=f.nodeValue;if(/[^\s\ufeff]/.test(m))f=null;h=/[\s\ufeff]$/.test(m)}else if(f.offsetWidth>0&&!f.getAttribute("_ke_bookmark"))if(o&&A.$removeEmpty[f.nodeName.toLowerCase()]){m=s.text(f);if(/[^\s\ufeff]/.test(m))f=
null;else for(var j=f.all||f.getElementsByTagName("*"),p=0,k;k=j[p++];)if(!A.$removeEmpty[k.nodeName.toLowerCase()]){f=null;break}if(f)h=!!m.length}else f=null;if(h)if(o)if(l)d=c;else c&&this.setStartBefore(c);else o=true;if(f){h=f.previousSibling;if(!c&&!h){c=new n(f);f=null;break}f=h}else c=null}if(c)c=c.parent()}h=this.endContainer;m=this.endOffset;c=f=null;l=o=false;if(h[0].nodeType==g.NODE_TEXT){h=!r.trim(h[0].nodeValue.substring(m)).length&&h;o=!(h&&h[0].nodeValue.length);if(h)if(!(f=h[0].nextSibling))c=
h.parent()}else(f=h[0].childNodes[m])||(c=h);for(;c||f;){if(c&&!f){if(!l&&s._4e_equals(c,a))l=true;if(!b._4e_contains(c))break;if(!o||c.css("display")!="inline"){o=false;if(l)e=c;else c&&this.setEndAfter(c)}f=c[0].nextSibling}for(;f;){h=false;if(f.nodeType==g.NODE_TEXT){m=f.nodeValue;if(/[^\s\ufeff]/.test(m))f=null;h=/^[\s\ufeff]/.test(m)}else if(f.offsetWidth>0&&!f.getAttribute("_ke_bookmark"))if(o&&A.$removeEmpty[f.nodeName.toLowerCase()]){m=s.text(f);if(/[^\s\ufeff]/.test(m))f=null;else{j=f.all||
f.getElementsByTagName("*");for(p=0;k=j[p++];)if(!A.$removeEmpty[k.nodeName.toLowerCase()]){f=null;break}}if(f)h=!!m.length}else f=null;if(h)if(o)if(l)e=c;else this.setEndAfter(c);if(f){h=f.nextSibling;if(!c&&!h){c=new n(f);f=null;break}f=h}else c=null}if(c)c=c.parent()}if(d&&e){a=d._4e_contains(e)?e:d;this.setStartBefore(a);this.setEndAfter(a)}break;case i.ENLARGE_BLOCK_CONTENTS:case i.ENLARGE_LIST_ITEM_CONTENTS:c=new z(this.document);b=new n(this.document.body);c.setStartAt(b,i.POSITION_AFTER_START);
c.setEnd(this.startContainer,this.startOffset);c=new u(c);var q,v,x=u.blockBoundary(a==i.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:null),D=function(y){var B=x(y);B||(q=y);return B};d=function(y){var B=D(y);if(!B&&y[0]&&y._4e_name()=="br")v=y;return B};c.guard=D;c=c.lastBackward();q=q||b;this.setStartAt(q,q._4e_name()!="br"&&(!c&&this.checkStartOfBlock()||c&&q._4e_contains(c))?i.POSITION_AFTER_START:i.POSITION_AFTER_END);c=this.clone();c.collapse();c.setEndAt(b,i.POSITION_BEFORE_END);c=new u(c);c.guard=a==
i.ENLARGE_LIST_ITEM_CONTENTS?d:D;q=null;c=c.lastForward();q=q||b;this.setEndAt(q,!c&&this.checkEndOfBlock()||c&&q._4e_contains(c)?i.POSITION_BEFORE_END:i.POSITION_BEFORE_START);v&&this.setEndAfter(v)}},checkStartOfBlock:function(){var a=this.startContainer,b=this.startOffset;if(b&&a[0].nodeType==g.NODE_TEXT)if(r.trim(a[0].nodeValue.substring(0,b)).length)return false;this.trim();a=new w(this.startContainer);b=this.clone();b.collapse(true);b.setStartAt(a.block||a.blockLimit,i.POSITION_AFTER_START);
a=new u(b);a.evaluator=F(true);return a.checkBackward()},checkEndOfBlock:function(){var a=this.endContainer,b=this.endOffset;if(a[0].nodeType==g.NODE_TEXT)if(r.trim(a[0].nodeValue.substring(b)).length)return false;this.trim();a=new w(this.endContainer);b=this.clone();b.collapse(false);b.setEndAt(a.block||a.blockLimit,i.POSITION_BEFORE_END);a=new u(b);a.evaluator=F(false);return a.checkForward()},deleteContents:function(){this.collapsed||this.execContentsAction(0)},extractContents:function(){var a=
this.document.createDocumentFragment();this.collapsed||this.execContentsAction(1,a);return a},checkBoundaryOfElement:function(a,b){var d=this.clone();d[b==i.START?"setStartAt":"setEndAt"](a,b==i.START?i.POSITION_AFTER_START:i.POSITION_BEFORE_END);a=new u(d);a.evaluator=I;return a[b==i.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var a=this.startContainer,b=this.endContainer,d=this.startOffset,e=this.endOffset,c;if(a[0].nodeType==g.NODE_ELEMENT){c=a[0].childNodes.length;if(c>
d)a=new n(a[0].childNodes[d]);else if(c<1)a=a._4e_previousSourceNode();else{for(a=a[0];a.lastChild;)a=a.lastChild;a=new n(a);a=a._4e_nextSourceNode()||a}}if(b[0].nodeType==g.NODE_ELEMENT){c=b[0].childNodes.length;if(c>e)b=(new n(b[0].childNodes[e]))._4e_previousSourceNode(true);else if(c<1)b=b._4e_previousSourceNode();else{for(b=b[0];b.lastChild;)b=b.lastChild;b=new n(b)}}if(a._4e_position(b)&O.POSITION_FOLLOWING)a=b;return{startNode:a,endNode:b}},fixBlock:function(a,b){var d=this.createBookmark();
b=new n(this.document.createElement(b));this.collapse(a);this.enlarge(i.ENLARGE_BLOCK_CONTENTS);b[0].appendChild(this.extractContents());b._4e_trim();C.ie||b._4e_appendBogus();this.insertNode(b);this.moveToBookmark(d);return b},splitBlock:function(a){var b=new w(this.startContainer),d=new w(this.endContainer),e=b.block,c=d.block,f=null;if(b.blockLimit[0]!==d.blockLimit[0])return null;if(a!="br"){if(!e){e=this.fixBlock(true,a);c=(new w(this.endContainer)).block}c||(c=this.fixBlock(false,a))}a=e&&this.checkStartOfBlock();
b=c&&this.checkEndOfBlock();this.deleteContents();if(e&&s._4e_equals(e,c))if(b){f=new w(this.startContainer);this.moveToPosition(c,i.POSITION_AFTER_END);c=null}else if(a){f=new w(this.startContainer);this.moveToPosition(e,i.POSITION_BEFORE_START);e=null}else{c=this.splitElement(e);!C.ie&&!r.inArray(e._4e_name(),["ul","ol"])&&e._4e_appendBogus()}return{previousBlock:e,nextBlock:c,wasStartOfBlock:a,wasEndOfBlock:b,elementPath:f}},splitElement:function(a){if(!this.collapsed)return null;this.setEndAt(a,
i.POSITION_BEFORE_END);var b=this.extractContents(),d=a._4e_clone(false);d[0].appendChild(b);d.insertAfter(a);this.moveToPosition(a,i.POSITION_AFTER_END);return d},moveToElementEditablePosition:function(a,b){var d,e=t.XHTML_DTD;if(e.$empty[a._4e_name()])return false;for(;a&&a[0].nodeType==g.NODE_ELEMENT;){if(d=a._4e_isEditable())this.moveToPosition(a,b?i.POSITION_BEFORE_END:i.POSITION_AFTER_START);else if(e.$inline[a._4e_name()]){this.moveToPosition(a,b?i.POSITION_AFTER_END:i.POSITION_BEFORE_START);
return true}if((a=e.$empty[a._4e_name()]?a[b?"_4e_previous":"_4e_next"](E):a[b?"_4e_last":"_4e_first"](E))&&a[0].nodeType==g.NODE_TEXT){this.moveToPosition(a,b?i.POSITION_AFTER_END:i.POSITION_BEFORE_START);return true}}return d},selectNodeContents:function(a){this.setStart(a,0);this.setEnd(a,a[0].nodeType==g.NODE_TEXT?a[0].nodeValue.length:a[0].childNodes.length)}});var L={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},J=new u.whitespaces,K=new u.bookmark;t.Range=z});
