KISSY.Editor.add("link",function(i){var e=KISSY.Editor;e.Link||function(){function f(a){this.editor=a;this._init()}function j(a){return a._4e_ascendant(function(b){return b._4e_name()==="a"&&!!b.attr("href")},true)}var h=KISSY,n=e.TripleButton,k=e.Style,o=h.Node,p=e.Range,q=e.SimpleOverlay,l=e.BubbleView,m={element:"a",attributes:{href:"#(href)",target:"#(target)"}};f.init=function(){var a=new q({title:"\u4fee\u6539\u94fe\u63a5",mask:true,width:"300px"});this.dialog=a;a.body.html("<div><p><label><span style='color:#0066CC;font-weight:bold;'>\u7f51\u5740\ufffd?</span><input class='ke-link-url' style='width:230px' value='http://'/></label></p><p style='margin-top: 5px;padding-left:45px'><label><input class='ke-link-blank' type='checkbox'/> &nbsp; \u5728\u65b0\u7a97\u53e3\u6253\u5f00\u94fe\u63a5</label></p></div>");
a.foot.html("<button class='ke-link-ok'>\u786e\u5b9a</button> <button class='ke-link-cancel'>\u53d6\u6d88</button>");a.urlEl=a.body.one(".ke-link-url");a.targetEl=a.body.one(".ke-link-blank");var b=a.foot.one(".ke-link-cancel");a.foot.one(".ke-link-ok").on("click",function(d){a.link._link();d.halt()},this);b.on("click",function(d){a.hide();d.halt()},this);f.init=null};l.register({pluginName:"link",func:j,init:function(){var a=this,b=a.el;b.html('\u524d\u5f80\u94fe\u63a5\ufffd? <a href=""  target="_blank" class="ke-bubbleview-url"></a> -  <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -  <span class="ke-bubbleview-link ke-bubbleview-remove">\u53bb\u9664</span>');
var d=b.one(".ke-bubbleview-url"),g=b.one(".ke-bubbleview-change");b=b.one(".ke-bubbleview-remove");g._4e_unselectable();d._4e_unselectable();b._4e_unselectable();g.on("click",function(c){a._plugin.show();c.halt()});b.on("click",function(c){a._plugin._removeLink(a._selectedEl);c.halt()});a.on("afterVisibleChange",function(){var c=a._selectedEl;if(c){d.html(c.attr("href"));d.attr("href",c.attr("href"))}})}});h.augment(f,{_init:function(){this.el=new n({container:this.editor.toolBarDiv,contentCls:"ke-toolbar-link",
title:"\u7f16\u8f91\u8d85\u94fe\ufffd?"});this.el.on("click",this.show,this);l.attach({pluginName:"link",pluginInstance:this})},_removeLink:function(a){var b=this.editor,d={href:a.attr("href")};if(a._4e_hasAttribute("target"))d.target=a.attr("target");a=new k(m,d);b.fire("save");a.remove(b.document);b.fire("save");b.notifySelectionChange()},_getSelectedLink:function(){var a=this.editor.getSelection().getRanges()[0].getCommonAncestor();if(a)a=j(a);return a},_link:function(){var a,b=this.editor,d=f.dialog,
g=d.urlEl.val(),c;if(h.trim(g)){d.hide();if(c=this._getSelectedLink()){a=new p(b.document);a.selectNodeContents(c);b.getSelection().selectRanges([a]);this._removeLink(c)}c={href:g};c.target=d.targetEl[0].checked?"_blank":"_self";a=b.getSelection().getRanges()[0];if(a.collapsed){a=new o("<a href='"+g+"' target='"+c.target+"'>"+g+"</a>",null,b.document);b.insertElement(a)}else{b.fire("save");a=new k(m,c);a.apply(b.document);b.fire("save")}b.notifySelectionChange()}},_prepare:function(){f.init&&f.init()},
_real:function(){var a=f.dialog,b=this._getSelectedLink();a.link=this;if(b){a.urlEl.val(b.attr("href"));a.targetEl[0].checked=b.attr("target")=="_blank"}a.show()},show:function(){this._prepare()}});e.Utils.lazyRun(f.prototype,"_prepare","_real");e.Link=f}();i.addPlugin(function(){new e.Link(i)})});
