KISSY.Editor.add("music",function(l){function m(b){return b.indexOf(o)!=-1}var f=KISSY.Editor,p=KISSY,k=f.Flash,i=l.htmlDataProcessor,g="ke_music",o="niftyplayer.swf",q=f.Utils.getFlashUrl,n=i&&i.dataFilter;n&&n.addRules({elements:{object:function(b){var d=b.attributes,e="ke_flash",h="flash";if(!(d.classid&&String(d.classid).toLowerCase())){for(d=0;d<b.children.length;d++)if(b.children[d].name=="embed"){if(!k.isFlashEmbed(b.children[d]))return null;if(m(b.children[d].attributes.src)){e=g;h="music"}return i.createFakeParserElement(b,
e,h,true)}return null}for(d=0;d<b.children.length;d++){var j=b.children[d];if(j.name=="param"&&j.attributes.name=="movie")if(m(j.attributes.value)){e=g;h="music";break}}return i.createFakeParserElement(b,e,h,true)},embed:function(b){if(!k.isFlashEmbed(b))return null;var d="ke_flash",e="flash";if(m(b.attributes.src)){d=g;e="music"}return i.createFakeParserElement(b,d,e,true)}}},4);f.MusicInserter||function(){function b(){b.superclass.constructor.apply(this,arguments)}function d(a){return a._4e_ascendant(function(c){return c._4e_name()===
"img"&&!!c.hasClass(g)},true)}function e(a){return a.replace(/^.+niftyplayer\.swf\?file=/,"")}var h=f.Config.base+'plugins/music/niftyplayer.swf?file=#(music)"',j=/#\(music\)/g,r=["img."+g];p.extend(b,k,{_config:function(){var a=this.editor;a._toolbars=a._toolbars||{};a._toolbars.music=this;this._cls=g;this._type="music";this._title="\u7f16\u8f91music";this._bodyHtml="<div><p><label><span style='color:#0066CC;font-weight:bold;'>\u97f3\u4e50\u7f51\u5740\ufffd?</span><input class='ke-music-url' style='width:230px' value='http://'/></label></p></div>";
this._footHtml="<button class='ke-music-ok'>\u786e\u5b9a</button> <button class='ke-music-cancel'>\u53d6\u6d88</button>";this._contentCls="ke-toolbar-music";this._tip="Music";this._contextMenu=s;this._flashRules=r},_initD:function(){var a=this,c=a.d;a.dUrl=c.el.one(".ke-music-url");var t=c.el.one(".ke-music-ok");c=c.el.one(".ke-music-cancel");t.on("click",a._gen,a);c.on("click",function(){a.d.hide()})},_getDWidth:function(){return"165"},_getDURl:function(){return h.replace(j,this.dUrl.val())},_getDHeight:function(){return"37"},
_getFlashUrl:function(a){return e(q(a))},_updateD:function(){var a=this.editor,c=this.selectedFlash;c?this.dUrl.val(this._getFlashUrl(a.restoreRealElement(c))):this.dUrl.val("")}});k.registerBubble("music","\u97f3\u4e50\u7f51\u5740\ufffd?",d);f.MusicInserter=b;var s={"\u7f16\u8f91\u97f3\u4e50":function(a){var c=a.getSelection();c=(c=c&&c.getStartElement())&&d(c);a=a._toolbars.music;if(c){a.selectedFlash=c;a.show()}}}}();l.addPlugin(function(){new f.MusicInserter(l)})});
